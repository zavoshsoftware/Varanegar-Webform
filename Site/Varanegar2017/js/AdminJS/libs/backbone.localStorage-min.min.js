(function(n,t){typeof exports=="object"&&n.require?module.exports=t(require("underscore"),require("backbone")):typeof define=="function"&&define.amd?define(["underscore","backbone"],function(i,r){return t(i||n._,r||n.Backbone)}):t(_,Backbone)})(this,function(n,t){function i(){return((1+Math.random())*65536|0).toString(16).substring(1)}function r(){return i()+i()+"-"+i()+"-"+i()+"-"+i()+"-"+i()+i()+i()}return t.LocalStorage=window.Store=function(n){if(!this.localStorage)throw"Backbone.localStorage: Environment does not support localStorage.";this.name=n;var t=this.localStorage().getItem(this.name);this.records=t&&t.split(",")||[]},n.extend(t.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(n){return n.id||(n.id=r(),n.set(n.idAttribute,n.id)),this.localStorage().setItem(this.name+"-"+n.id,JSON.stringify(n)),this.records.push(n.id.toString()),this.save(),this.find(n)},update:function(t){return this.localStorage().setItem(this.name+"-"+t.id,JSON.stringify(t)),n.include(this.records,t.id.toString())||this.records.push(t.id.toString()),this.save(),this.find(t)},find:function(n){return this.jsonData(this.localStorage().getItem(this.name+"-"+n.id))},findAll:function(){return(n.chain||n)(this.records).map(function(n){return this.jsonData(this.localStorage().getItem(this.name+"-"+n))},this).compact().value()},destroy:function(t){return t.isNew()?!1:(this.localStorage().removeItem(this.name+"-"+t.id),this.records=n.reject(this.records,function(n){return n===t.id.toString()}),this.save(),t)},localStorage:function(){return localStorage},jsonData:function(n){return n&&JSON.parse(n)},_clear:function(){var t=this.localStorage(),i=new RegExp("^"+this.name+"-");t.removeItem(this.name);(n.chain||n)(t).keys().filter(function(n){return i.test(n)}).each(function(n){t.removeItem(n)});this.records.length=0},_storageSize:function(){return this.localStorage().length}}),t.LocalStorage.sync=window.Store.sync=t.localSync=function(n,i,r){var e=i.localStorage||i.collection.localStorage,u,f,o=t.$.Deferred&&t.$.Deferred();try{switch(n){case"read":u=i.id!=undefined?e.find(i):e.findAll();break;case"create":u=e.create(i);break;case"update":u=e.update(i);break;case"delete":u=e.destroy(i)}}catch(s){f=s.code===22&&e._storageSize()===0?"Private browsing is unsupported":s.message}return u?(r&&r.success&&(t.VERSION==="0.9.10"?r.success(i,u,r):r.success(u)),o&&o.resolve(u)):(f=f?f:"Record Not Found",r&&r.error&&(t.VERSION==="0.9.10"?r.error(i,f,r):r.error(f)),o&&o.reject(f)),r&&r.complete&&r.complete(u),o&&o.promise()},t.ajaxSync=t.sync,t.getSyncMethod=function(n){return n.localStorage||n.collection&&n.collection.localStorage?t.localSync:t.ajaxSync},t.sync=function(n,i,r){return t.getSyncMethod(i).apply(this,[n,i,r])},t.LocalStorage});