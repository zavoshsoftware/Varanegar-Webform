$(function(){var i=Backbone.Model.extend({defaults:function(){return{id:n.nextId(),name:"New note",description:"",date:Date.now()}}}),r=Backbone.Collection.extend({model:i,localStorage:new Backbone.LocalStorage("notes-app"),nextId:function(){return this.url?null:this.length?this.last().get("id")+1:1},comparator:function(n){return parseInt(n.get("id"))},search:function(n){var t=new RegExp(n,"gi");return _(this.filter(function(n){n.trigger("show");t.test(n.get("description"))==!1&&n.trigger("hide")}))}}),n=new r,u=Backbone.View.extend({tagName:"li",className:"list-group-item hover",template:_.template($("#item-template").html()),events:{"click .destroy":"clear",click:"select"},initialize:function(){this.listenTo(this.model,"change",this.render);this.listenTo(this.model,"destroy",this.remove);this.listenTo(this.model,"select",this.select);this.listenTo(this.model,"active",this.active);this.listenTo(this.model,"hide",this.hide);this.listenTo(this.model,"show",this.show)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},clear:function(){this.model.destroy();window.history.back()},select:function(){this.active();t.navigate("notes/"+this.model.get("id"),{trigger:!0})},active:function(){this.$el.parent().find(".active").removeClass("active");this.$el.addClass("active")},hide:function(){this.$el.addClass("hide")},show:function(){this.$el.removeClass("hide")}}),f=Backbone.View.extend({el:$("#note-list"),events:{"click #new-note":"create","keyup #search-note":"search"},initialize:function(){this.listenTo(n,"add",this.addOne);this.listenTo(n,"reset",this.addAll);this.listenTo(n,"all",this.render)},render:function(){},addOne:function(n){var t=new u({model:n});this.$el.find("#note-items").prepend(t.render().el)},addAll:function(){n.each(this.addOne,this)},create:function(){var t=new i;n.create(t,{success:function(){t.trigger("select")}})},search:function(){n.search($("#search-note").val())}}),e=Backbone.View.extend({el:$("#note-detail"),template:_.template($("#note-template").html()),events:{"keyup textarea":"updateOnKeyup"},initialize:function(){this.$el.html(this.template(this.model.toJSON()))},updateOnKeyup:function(n){var t="",i=$(n.target).val(),r=i.split(/\r\n|\r|\n/g);r.length&&(t=_.first(_.filter(r,function(n){return!!$.trim(n)})));this.model.save({name:t,description:i})},close:function(){this.$el.unbind();this.$el.empty()}}),o=Backbone.Router.extend({routes:{"":"list","notes/:id":"details"},initialize:function(){},list:function(){if(!this.noteListView){this.noteListView=new f;var i=this;n.fetch({success:function(){var r=t.requiredId||n.length&&n.at(n.length-1).get("id");n.length&&i.details(r)&&t.navigate("notes/"+r);n.length||$("#new-note").trigger("click")}})}},details:function(i){return t.requiredId=i,this.list(),this.noteView&&this.noteView.close(),this.note=n.get(i),this.note&&(this.note.trigger("active"),this.noteView=new e({model:this.note})),this}}),t=new o;Backbone.history.start()});